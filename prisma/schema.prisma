generator client {
  provider        = "prisma-client"
  output          = "../generated/prisma"
  previewFeatures = ["relationJoins"]
}

datasource db {
  provider = "postgresql"
}

model Listing {
  id           Int           @id @default(autoincrement())
  address      String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  applications Application[]

  @@index([address])
}

model Application {
  id                    Int                   @id @default(autoincrement())
  applicantName         String
  applicantEmail        String
  listingId             Int
  status                String                @default("draft")
  workflowRunId         String?
  workflowStatus        String?
  lastCompletedStep     String?
  workflowErrorDetails  Json?
  fraudScore            Float?
  fraudSignals          Json?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  listing               Listing               @relation(fields: [listingId], references: [id], onDelete: Cascade)
  documents             ApplicationDocument[]
  reviewDecisions       HumanReviewDecision[]

  @@index([listingId])
  @@index([applicantEmail])
  @@index([applicantName])
  @@index([status])
  @@index([fraudScore])
  @@index([workflowStatus])
}

model ApplicationDocument {
  applicationId      Int
  documentType       String
  verificationStatus String      @default("pending")
  aiExtractedData    Json?
  confidenceScore    Float?
  workflowStepId     String?
  id                 Int         @id @default(autoincrement())
  documentId         Int
  application        Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  document           Document    @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([applicationId, documentId])
  @@index([applicationId])
  @@index([documentId])
}

model HumanReviewDecision {
  applicationId Int
  workflowRunId String
  decision      String?     @default("")  
  reason        String?      @default("")
  fraudContext  Json?
  status        String      @default("pending")
  reviewedAt    DateTime?
  createdAt     DateTime    @default(now())
  id            Int         @id @default(autoincrement())
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId])
}

model Document {
  blobUrl              String
  filename             String
  fileSize             Int
  mimeType             String
  uploadedAt           DateTime              @default(now())
  status               String                @default("uploaded")
  id                   Int                   @id @default(autoincrement())
  applicationDocuments ApplicationDocument[]
}
